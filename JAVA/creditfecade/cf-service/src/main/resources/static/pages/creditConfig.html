<!DOCTYPE html>
<html lang="en" >
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="../jquery-2.1.1.min.js"></script>
    <script src="../bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
    <script src="../bootstrap-3.3.7-dist/js/bootstrap-table.min.js"></script>
    <script src="../bootstrap-3.3.7-dist/js/bootstarp-table-zh-CN.min.js"></script>
    <link rel="stylesheet" type="text/css" href="../bootstrap-3.3.7-dist/css/bootstrap-table.min.css" >
    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css">
    
    
    <script src="../js/base.js"></script>
</head>

<body>

        <div style="position: absolute;width: 100%;height: 100%;padding: 10px;margin:7em auto 0;">
            <!-- 所有管道展示 -->
            已有项目
            <table id="left-table" data-toggle="table">
                <thead>
                     <tr>
                         <th data-field="seqno">序号</span></th>
                         <th data-field="name">项目名称</th>
                         <th data-field="btn" ><button class="btn" data-toggle="modal" data-target="#myModal">添加</button></th>
                     </tr>
                 </thead>
            </table>
        </div>

        <!-- 弹窗框 -->
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="top: 13%;">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" id="myModalLabel">详情</h4>
                    </div>
                    <div class="modal-body">

                        <div class="form-group">
                            <label >项目名称</label>
                            <input type="text" class="form-control" id="input-plname" placeholder="请输入名称">
                        </div>

                        <table class="table" id="pl-step-table" data-toggle="table">
                            <thead>
                                <tr>
                                    <th data-field="seqno">序号</th>
                                    <th data-field="sname">授信步骤名称</th>
                                    <th data-field="ustatus">开关状态</th>
                                    <th data-field="ops">操作</th>
                                </tr>
                            </thead>
                        </table>
                        <table class="table">
                            <thead>
                            <tr>
                               <!--  <th><select id="add-id-selector" class="form-control"></select></th> -->
                                <th>
                                    <select id="add-name-selector" class="form-control"></select>
                                </th>
                                <th><button class="btn" onclick="addStepToPl()">添加</button></th>
                            </tr>
                            </thead>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- 顺序选择框 -->
        <div class="modal fade" id="reindex-dix" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-body">
                        <h5 class="modal-title" id="reindex-name"></h5>
                        <input id="reindex-id" hidden>
                        <select id="reindex-selector" class="form-control"></select>
                        <button type="button" class="btn btn-default" onclick="reindex()">确定</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    </div>
                </div>
            </div>
        </div>
</body>

<script>
var host = "http://" + window.location.host + "/cc-service";
var piplineSteps;

$(function(){
	initProjectList();
})

//项目列表
var initProjectList = function(){
	$.ajax({
        url: host + "/config/projects",
        method: 'GET',
        success: function(data){
        	console.log(data);
        	var list = data.content;
            var length = list.length;
            var projectArray = new Array();
            for (var i=0;i<length;i++){
	        	console.log(list[i]);
	        	projectArray.push({
                    seqno: i,
                    name: list[i],
                    btn: '<button class="btn" data-toggle="modal" data-target="#myModal" data-plkey="'+list[i]+'">详情</button>'
                });
            }
            $('#left-table').bootstrapTable("load", projectArray);
        },
        error:function(edate){
            alert("error");
        }
    })
	
}

$('#reindex-dix').on('show.bs.modal', function (event){
    var button = $(event.relatedTarget)
    var name = button.data('name')
    var length = button.data('length')
    var id = button.data('id')
    var oldindex = button.data('oldindex')
    var selector = $('#reindex-selector')
    selector.empty()
    for(var i=0;i<length;i++){
        var c = i+1;
        if(oldindex != i) {
            selector.append('<option value="' + c + '">' + c + '</option>');
        }
    }
    $('#reindex-id').val(id);
    $('#reindex-name').text(name);
})

$('#myModal').on('show.bs.modal', function (event) {
    var button = $(event.relatedTarget) // 触发事件的按钮
    var plkey = button.data('plkey') // 解析出whatever内容

    $('#add-name-selector').empty();
    $('#pl-step-table').bootstrapTable("load", []);
    $('#input-plname').removeAttr("readonly");
    $('#input-plname').val(plkey);
    if(plkey!=null) {
        $('#input-plname').attr("readonly","readonly");
        editClick(plkey);
    }else{
        //$('#add-id-selector').append('<option value="0">0</option>');
    }
    initStepSelect();
})


var editClick = function(plkey) {
    piplineSteps = new Array();

    $.ajax({
        url: host + "/config/detailList/" + plkey,
        method: 'GET',
        success: function(data){
        	data = data.content; 
            var length = data.length;
            for (var i=0;i<length;i++){
                piplineSteps.push({
                    seqno: data[i].seqNo,
                	id:data[i].id,
                    sname: data[i].stepName,
                    ustatus: (data[i].useStatus == 1?"已开启":"已关闭"),
                    ops: '<button class="btn" onclick="changeUseStatus(\''+ plkey +'\','+ data[i].id +','+(data[i].useStatus==1?false:true)+')">'+(data[i].useStatus==1?'关闭':'开启')+'</button>'+
                    '<button style="margin-left: 10px" class="btn" data-toggle="modal" data-target="#reindex-dix" data-name="'+data[i].stepName+'" data-length="'+length+'" data-id="'+data[i].id+'" data-oldindex="'+i+'">设置顺序号</button>'
                    /*(data[i].seqNo==1?'<a class="btn" ><span >&nbsp&nbsp&nbsp</span></a>':'<a class="btn" onclick="sort('+data[i].id+',-1)"><span class="glyphicon glyphicon-arrow-up"></span></a>')+
                    (data[i].seqNo==length?"":'<a class="btn" onclick="sort('+data[i].id+',1)"><span class="glyphicon glyphicon-arrow-down"></span></a>')*/
                    
                });
            }
            $('#pl-step-table').bootstrapTable("load", piplineSteps);
        },
        error:function(edate){
            alert("error");
        }
    });
    
}

//调整顺序
var reindex = function(){

    var id = $('#reindex-id').val();
    var newindex = $('#reindex-selector').val();
    $('#reindex-dix').modal('hide')
	$.ajax({
        url: host + "/config/reindex",
        method: 'POST',
        data:{"id":id,"sort":newindex},
        type:"JSON",
        success: function(data){
        	var stepKey = $("#input-plname").val();
            editClick(stepKey);
        },
        error:function(edate){
            alert("error");
        }
    })
}
//授信环节
var initStepSelect = function(){
    $.ajax({
        url: host + "/config/steps",
        method: 'GET',
        success: function(data){
        	console.log(data);
        	data = data.content; 
            var length = data.length;
            for (var i=0;i<length;i++){
                //$('#add-id-selector').append('<option value="'+i+'">'+i+'</option>');
            	$('#add-name-selector').append('<option value="'+data[i]+'">'+data[i]+'</option>');
            }
        },
        error:function(edate){
            alert("error");
        }
    })
}
var changeUseStatus = function(plkey,id,flag){

    var data = {
        "projectName": plkey,
        "id": id,
        "flag": flag
    };
    $.ajax({
        url: host + "/config/changeUseStatus",
        method: 'POST',
        data: {
            "projectName": plkey,
            "id": id,
            "flag": flag
        },
        success: function(data){
          var stepKey = $("#input-plname").val();
          editClick(stepKey);
        },
        error: function (msg) {
            alert("请求异常");
            console.log(msg);
        }
    })
}


var addStepToPl = function(){
   // var index = $("#add-id-selector").val();
    var stepKey = $("#add-name-selector").val();
    var plkey = $("#input-plname").val();
    var data = JSON.stringify({
    	projectName: plkey,
        stepName: stepKey
    });
    
    $.ajax({
        url: host + "/config/addStep",
        type: 'POST',
        data: data,
        contentType: 'application/json;charset=utf-8',
        success: function(data){
        	var stepKey = $("#input-plname").val();
            editClick(stepKey);
        },
        error: function (msg) {
            alert("请求异常");
            console.log(msg);
        }
    })
}



</script>

</html>
