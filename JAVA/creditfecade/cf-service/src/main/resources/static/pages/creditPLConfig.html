<!DOCTYPE html>
<html lang="en" >
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="../jquery-2.1.1.min.js"></script>
    <script src="../bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
    <script src="../bootstrap-3.3.7-dist/js/bootstrap-table.min.js"></script>
    <script src="../bootstrap-3.3.7-dist/js/bootstarp-table-zh-CN.min.js"></script>
    <link rel="stylesheet" type="text/css" href="../bootstrap-3.3.7-dist/css/bootstrap-table.min.css" >
    <link rel="stylesheet" type="text/css" href="../bootstrap-3.3.7-dist/css/bootstrap.min.css" >

</head>

<body>

        <div style="position: absolute;width: 45%;height: 100%;padding: 2px">
            <!-- 所有管道展示 -->
            已有项目
            <table id="left-table" data-toggle="table">
                <thead>
                     <tr>
                         <th data-field="seqno">序号</th>
                         <th data-field="name">项目名称</th>
                         <th data-field="btn" ><button class="btn" data-toggle="modal" data-target="#myModal">添加</button></th>
                     </tr>
                 </thead>
                 <!--<tbody>
                     <tr><td>1</td><td>ww</td><td><button class="btn">详情</button></td></tr>
                 </tbody>-->
            </table>
        </div>

        <div  style="position: absolute;width: 45%;height: 100%;left: 50%">
            已有步骤
            <table id="right-table" data-toggle="table" style="width: 100%;text-align: center">
                <thead>
                    <tr>
                        <th data-field="seqno" width="200px">序号</th>
                        <th data-field="sname" width="200px">步骤名称</th>
                    </tr>
                </thead>
            </table>
        </div>


        <!-- 弹窗框 -->
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="top: 20%">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" id="myModalLabel">详情</h4>
                    </div>
                    <div class="modal-body">

                        <div class="form-group">
                            <label >管道名称</label>
                            <input type="text" class="form-control" id="input-plname" placeholder="请输入名称">
                        </div>

                        <table class="table" id="pl-step-table" data-toggle="table">
                            <thead>
                                <tr>
                                    <th data-field="seqno">序号</th>
                                    <th data-field="sname">步骤名称</th>
                                    <th data-field="ops">操作</th>
                                </tr>
                            </thead>
                            <!--<tbody>
                                <tr>
                                    <td>1</td><td>test</td><td><button class="btn">移除</button></td>
                                </tr>
                            </tbody>-->
                        </table>
                        <table class="table">
                            <thead>
                            <tr>
                                <th><select id="add-id-selector" class="form-control"></select></th>
                                <th>
                                    <select id="add-name-selector" class="form-control"></select>
                                </th>
                                <th><button class="btn" onclick="addStepToPl()">添加</button></th>
                            </tr>
                            </thead>
                        </table>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal -->
        </div>

        <!--<div class="alert alert-success alert-dismissable">
            <button type="button" class="close" data-dismiss="alert"
                    aria-hidden="true">
                &times;
            </button>
            修改完成
        </div>-->
</body>

<script>
var host = "http://" + window.location.host + "/cc-service";
var stepKeys = new Array();
var piplineSteps;

$('#left-table').bootstrapTable({
    striped: true,
    pagination:true,
    url: host + "/plkeys",
    columns: [ {
        field: 'seqno',
        formatter: function (value, row, index) {
            return index+1;
        }
    },{
        field: 'name',
        formatter: function (value, row, index) {
            return row;
        }
    },{
        field: 'btn',
        formatter: function (value, row, index) {
            return '<button class="btn" data-toggle="modal" data-target="#myModal" data-plkey="'+row+'">详情</button>';
        }
    }]
});

$('#right-table').bootstrapTable({
    striped: true,
    pagination:true,
    url: host + "/stepkeys",
    columns: [ {
        field: 'seqno',
        formatter: function (value, row, index) {
            return index+1;
        }
    },{
        field: 'sname',
        formatter: function (value, row, index) {
            //stepKeys.push(row);
            $('#add-name-selector').append('<option value="'+row+'">'+row+'</option>');
            //$('#add-id-selector').append('<option value="'+index+'">'+index+'</option>');
            return row;
        }
    }]
});

$('#myModal').on('show.bs.modal', function (event) {
    var button = $(event.relatedTarget) // 触发事件的按钮
    var plkey = button.data('plkey') // 解析出whatever内容
    //var modal = $(this)  //获得模态框本身

    $('#add-id-selector').empty();
    $('#pl-step-table').bootstrapTable("load", []);
    $('#input-plname').removeAttr("readonly");
    $('#input-plname').val(plkey);
    if(plkey!=null) {
        console.log(">>>>>>>>")
        $('#input-plname').attr("readonly","readonly");
        editClick(plkey);
    }else{
        $('#add-id-selector').append('<option value="0">0</option>');
    }
    console.log("plkey=="+plkey)
})


var editClick = function(plkey) {
    piplineSteps = new Array();
    $.ajax({
        url: host + "/plstepkeys/" + plkey,
        method: 'GET',
        success: function(data){
            var length = data.length;
            for (var i=0;i<length;i++){
                piplineSteps.push({
                    seqno: i,
                    sname: data[i],
                    ops: '<button class="btn" onclick="removeStepOfPl('+i+',\''+plkey+'\')">移除</button>'
                });
                $('#add-id-selector').append('<option value="'+i+'">'+i+'</option>');
            }
            $('#add-id-selector').append('<option value="'+length+'">'+length+'</option>');
            $('#pl-step-table').bootstrapTable("load", piplineSteps);
        },
        error:function(edate){
            alert("error");
        }
    })
}

var removeStepOfPl = function(index,plkey){
    var data = JSON.stringify({
        plKey: plkey,
        index: index
    });
    $.ajax({
        url: host + "/remove-step",
        type: 'POST',
        data: data,
        contentType: 'application/json;charset=utf-8',
        success: function(data){
          location.reload();
        },
        error: function (msg) {
            alert("请求异常");
            console.log(msg);
        }
    })
}

var addStepToPl = function(){
    var index = $("#add-id-selector").val();
    var stepKey = $("#add-name-selector").val();
    var plkey = $("#input-plname").val();
    var data = JSON.stringify({
        plKey: plkey,
        index: index,
        stepKey: stepKey
    });
    $.ajax({
        url: host + "/addstep",
        type: 'POST',
        data: data,
        contentType: 'application/json;charset=utf-8',
        success: function(data){
            location.reload();
        },
        error: function (msg) {
            alert("请求异常");
            console.log(msg);
        }
    })
}



</script>

</html>
